/* ************************************************************************** */
/*                                                                            */
/*                                                        :::      ::::::::   */
/*   filler_no_gnl.c                                    :+:      :+:    :+:   */
/*                                                    +:+ +:+         +:+     */
/*   By: ftrujill <marvin@42.fr>                    +#+  +:+       +#+        */
/*                                                +#+#+#+#+#+   +#+           */
/*   Created: 2019/06/13 22:25:35 by ftrujill          #+#    #+#             */
/*   Updated: 2019/06/17 08:06:04 by ftrujill         ###   ########.fr       */
/*                                                                            */
/* ************************************************************************** */

#include "filler.h"
#include "libft/libft.h"
#include <stdio.h>
#include <fcntl.h>

int     get_next_line_triv(int fd, char **line, t_tab map)
{
    int i;

    if(!(*line = (char*)malloc(map->y + 1)))
        return (0);
    i = 0;
    while(i <= map->y && read(fd, *line + i, 1) && *(*line + i) != '\n')
        i++;
    if (*(*line + i) != '\n')
    {
        *(*line + i) != 0;
        return (1)
    }
    return (0);
    
}

int     prt_error(int fd)
{
    ft_putstr_fd("ERROR\n", fd);
    close(fd);
    return (-1);
}

int     prt_error_init(int fd)
{
    ft_putstr_fd("ERROR init\n", fd);
    close(fd);
    return (-1);
}

int     prt_error_piece(int fd)
{
    ft_putstr_fd("ERROR piece\n", fd);
    close(fd);
    return (-1);
}

int    get_map(t_tab *map, char **line, int fd)
{
    int i;
    int j;
  
    if (!(map->tab = (char**)malloc(sizeof(char*) * map->x)))
        return (prt_error(fd));
    i = 0;
    get_next_line(0, line);
    free(*line);
    while(i < map->x)
    {
        j = 0;
        get_next_line(0, line);
        while ((*line)[j] && (*line)[j] != ' ')
            j++;
        if (!(*line)[j])
           return (prt_error_init(fd));
        if (!(map->tab[i++] = ft_strdup((*line) + j + 1)))
            return (-1);
        free(*line);
    }
    return (0);
}

void prt_all(char **line, int fd)
{
    while(get_next_line(0, line))
        {
            ft_putstr_fd(*line, fd);
            write(fd, "\n", 1);
            free(*line);
        }
}

void prt_tab(t_tab *tab, int fd)
{
    int i;

    i = 0;
    ft_putnbr_fd(tab->x, fd);
            write(fd, "\n", 1);
    ft_putnbr_fd(tab->y, fd);
            write(fd, "\n", 1);  
    while (i < tab->x)
    {
        ft_putstr_fd(tab->tab[i++], fd);
        write(fd, "\n", 1);
    }
}

void    free_tab(t_tab *tab)
{
    int i;

    i = 0;
    while (i < tab->x)
        free(tab->tab[i++]);
    free(tab->tab);
    free(tab);
}

void    free_all(char **line, t_tab *map, t_tab *piece, int fd)
{
    int i;

    i = 0;
    while (i <= map->x)
    {
        free(map->tab[i]);
        free(piece->tab[i++]);
    }
    free(map->tab);
    free(piece->tab);
    free(map);
    free(piece);
    free(line);
}

int    init(char **line, t_tab *map, t_tab *piece, int fd)
{
    int i;

    get_next_line(0, line);
    if (ft_strlen(*line) < 11 || !(*(*line + 10) == '1' || *(*line + 10) == '2'))
            return (prt_error(fd));
    map->c = *(*line + 10) == '1' ? 'O' : 'X';
    piece->c = *(*line + 10) == '1' ? 'X' : 'O';
    free(*line);
    get_next_line(0, line);
    if (ft_strncmp(*line, "Plateau ", 8))
        return (prt_error_init(fd));
    map->x = ft_atoi(*line + 8);
    i = 9;
    while (*(*line + i) && *(*line + i) != ' ')
        i++;
    if (!(*(*line + i)))
        return (prt_error_init(fd));
    map->y = ft_atoi(*line + i + 1);
    free(*line);
    if (!(map->tab = (char**)malloc(sizeof(char*) * (map->x + 1))) ||
        !(piece->tab = (char**)malloc(sizeof(char*) * (map->x + 1))))
        return (prt_error_init(fd));
    i = 0;
    while (i < map->x)
    {
        if (!(map->tab[i] = (char*)ft_memalloc(map->y + 1))
            || !(piece->tab[i] = (char*)ft_memalloc(map->y + 1)))
            return (prt_error_init(fd));
        i++;
    }
    map->tab[i] = 0;
    piece->tab[i] = 0;
    return (1);
}

int     copy_piece(char **line, t_tab *piece, int fd)
{
    int i;

    get_next_line(0, line);
    if (ft_strncmp(*line, "Piece ", 6))
        return (prt_error_piece(fd));
    piece->x = ft_atoi(*line + 6);
    i = 7;
    while (*(*line + i) && *(*line + i) != ' ')
        i++;
    if (!(*(*line + i)))
        return (prt_error_piece(fd));
    piece->y = ft_atoi(*line + i + 1);
    free(*line);
    if (!piece->y || !piece->x)
        return (prt_error_piece(fd));
    i = 0;
    while(i < piece->x)
    {
        get_next_line(0, line);
        if (ft_strlen(*line) != piece->y)
            return (prt_error_piece(fd));
        ft_memcpy(piece->tab[i], *line, ft_strlen(*line) + 1);
        i++;
        free(*line);
    }
    return (1);
}

void     reset_piece(t_tab *piece, t_tab *map)
{
    int i;

    i = 0;
    while (i < map->x)
            ft_memset(piece->tab[i++], 0, map->y + 1);
}

int     copy_map(char **line, t_tab *map, int fd, int l_size)
{
    int i;
    int j;
    char tmp[l_size + 1];
    i = 0;
    while (i < map->x)
    {
    
        if (!get_next_line(0, line) || !ft_isdigit(**line) || ft_strlen(*line) != l_size) 
        {
            ft_putstr_fd("ERROR COPY MAP\n", fd);
            ft_putstr_fd(*line, fd);
            return (0);            
        }
        ft_memcpy(map->tab[i], *line + l_size - map->y, ft_strlen(*line + l_size - map->y + 1) + 1);    
        i++;
        free(*line);
    }
    return (1);
}

int     valid_pos(t_tab *map, t_tab *piece, int x, int y, int fd)
{
    int i;
    int j;
    int r;

    if (x >= map->x - piece->x || y >= map->y - piece->y)
        return (0);
    r = 0;
    i = 0;
    while (i < piece->x)
    {
        j = 0;
        while (j < piece->y)
        {
            if (piece->tab[i][j] == '.')
                j++;
            else
            {
                if (piece->tab[i][j] == '*' && map->tab[x + i][y + j] == piece->c)
                    return (0);
                if (piece->tab[i][j] == '*' && map->tab[x + i][y + j] == map->c)
                    r++;
                if (r > 1)
                    return (0);
                j++;
            }
        }
        i++;
    }
    /* write(fd, "\nPosition ", 10);
    ft_putnbr_fd(x, fd);
    write(fd, " ", 1);
    ft_putnbr_fd(y, fd);
    write(fd, " ", 1);
    ft_putnbr_fd(r, fd);*/
    return (r);
}

void    write_pos(t_tab *map, t_tab *piece, int fd)
{
    int x;
    int y;

    x = 0;
    while (x < map->x)
    {
        y = 0;
        while (y < map->y)
        {
            if (valid_pos(map, piece, x, y, fd))
                {
                    ft_putstr_fd("Got here\n", fd);
                    ft_putnbr(x);
                    write(1, " ", 1);
                    ft_putnbr(y);
                    write(1, "\n", 1);
                    return ;
                }
            y++;
        }
        x++;
    }
}

int     main(int argc, char **argv)
{

    int fd;
    int fd2;
    t_tab   *map;
    t_tab   *piece;
    char    **line;
    int     l_size;
    int i;

    if (!(map = (t_tab*)malloc(sizeof(t_tab))) || 
        !(piece = (t_tab*)malloc(sizeof(t_tab))) ||
        !(line = (char**)malloc(sizeof(char*))))
        return (0);
    
    fd = open("file", O_RDWR | O_CREAT, 0777);
    if (!(init(line, map, piece, fd)))
        return (0);
    fd2 = open("map", O_RDWR | O_CREAT, 0777);
    if (!get_next_line(0, line) || (l_size = ft_strlen(*line)) < map->y)
        return (prt_error(fd2));
    free(*line);
    if (!copy_map(line, map, fd2, l_size))
        return (0);
    prt_tab(map, fd2);
    if (!copy_piece(line, piece, fd2))
        return (0);
    prt_tab(piece, fd2);
    write_pos(map, piece, fd2);
    //write(1, "1 1\n", 4);
    while(get_next_line(0, line) && **line == 'P')
    {
        free(*line);
        if (!get_next_line(0, line) || **line != ' ' || ft_strlen(*line) != map->y + 4)
            {
                ft_putstr_fd("Error in    01234567\n", fd2);
                ft_putstr_fd(*line, fd2);
                break ;
            }
        if (!copy_map(line, map, fd2, l_size))
            {
                break ;
            }
        prt_tab(map, fd2);
        if (!copy_piece(line, piece, fd2))
            break ;
        prt_tab(piece, fd2);
        write_pos(map, piece, fd2);
       // write(1, "1 1\n", 4);
    }
    write(fd2, "Got out\n", 8);
    /*
    while(get_next_line(0, line))
    {
        ft_putstr_fd(*line, fd);
        write(fd, "\n", 1);
        if (**line == '.' || **line == '*')
            write(1, "1 1\n", 4);
        free(*line);
        i++;
    }
    */
    free(*line);
    free_all(line, map, piece, fd);
    write(fd, "GAME OVER\n", 10);
    close (fd);
    close (fd2);
    return (0);
}
